{"version":3,"sources":["../src/index.js"],"names":["require","DEFAULT_ECDH_CURVE","homedir","os","path","join","atma","init","server","config","ATMA_URL","successOrError","statusCode","log","error","success","responseTime","time","bold","lightError","morganMiddleware","tokens","req","res","method","status","url","date","cmdValue","program","version","description","usage","arguments","action","cmd","command","option","options","OPTS","port","spa","showHidden","hidden","APP_DIR","process","cwd","app","use","targetSite","targetPath","originalUrl","split","result","type","sendFile","send","listen","console","deployment","new_link","authFile","auth","JSON","parse","logout","token","exit","argv","help"],"mappings":"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","file":"index.js","sourcesContent":["\nrequire(\"tls\").DEFAULT_ECDH_CURVE = \"auto\"\nimport path from 'path'\nimport { existsSync, mkdirSync, readFileSync, unlinkSync } from 'fs'\n\nimport express from 'express'\nimport morgan from 'morgan'\n\nimport os from 'os'\nimport program from 'commander'\n\nimport sera from '@evius/sera'\nimport atma from '@evius/atma-client'\n\nimport log from './lib/log'\nimport deploy from './lib/deploy'\nimport login from './lib/login'\nimport register from './lib/register'\nimport link from './lib/link'\nimport config from './lib/config'\n\nconst homedir = os.homedir()\nif(!existsSync(path.join(homedir, '.serph'))) {\n\tmkdirSync(path.join(homedir, '.serph'))\n}\n\natma.init({\n\tserver: config.ATMA_URL\n})\n\nconst successOrError = (statusCode) => {\n\tif(statusCode >= 400) {\n\t\treturn log.error(statusCode)\n\t}\n\treturn log.success(statusCode)\n}\n\nconst responseTime = (time) => {\n\tif(time < 3000) {\n\t\treturn log.bold(`${time} ms`)\n\t}\n\tif(time < 5000) {\n\t\treturn log.lightError(`${time} ms`)\n\t}\n\treturn log.lightError(`${time} ms`)\n}\n\nconst morganMiddleware = morgan(function (tokens, req, res) {\n\treturn [\n\t\tlog.bold(`--> ${tokens.method(req, res)}`),\n\t\tsuccessOrError(tokens.status(req, res)),\n\t\tlog.url(tokens.url(req, res)),\n\t\tresponseTime(tokens['response-time'](req, res)),\n\t\tlog.bold('- ' + tokens.date(req, res))\n\t].join(' ')\n})\n\nlet cmdValue\n\nprogram\n\t.version('0.1.0')\n\t.description('Minimalist http-server for static site')\n\t.usage('<commands> [options]')\n\t.arguments('<cmd>')\n\t.action((cmd) => {\n\t\tcmdValue = cmd\n\t})\n\nprogram\n\t.command('local')\n\t.description('serve static file locally')\n\t.option('--port <n>', 'port to use')\n\t.option('--spa', 'redirect all route to index.html')\n\t.option('--no-hidden', 'ignore all request to dot files (hidden)')\n\t.action(function (options) {\n\t\tcmdValue = 'local'\n\n\t\tconst OPTS = {\n\t\t\tport: options.port || 8080,\n\t\t\tspa: options.spa || false,\n\t\t\tshowHidden: options.hidden\n\t\t}\n\t\t\n\t\tconst APP_DIR = process.cwd()\n\t\t\n\t\tif(existsSync(path.join(APP_DIR, 'index.html'))) {\n\t\t\tconst app = express()\n\t\t\n\t\t\tapp.use(morganMiddleware)\n\t\t\t// app.use('*', sera(APP_DIR, OPTS))\n\n\t\t\tapp.use('*', async (req, res) => {\n\t\t\t\tconst targetSite = APP_DIR\n\t\t\t\tconst targetPath = req.originalUrl.split('?')[0]\n\t\t\n\t\t\t\tif(existsSync(targetSite)) {\n\t\t\t\t\tconst result = await sera(targetSite, targetPath, {\n\t\t\t\t\t\tspa: options.spa,\n\t\t\t\t\t\tshowHidden: options.hidden\n\t\t\t\t\t})\n\t\t\t\t\tif(result.status === 200) {\n\t\t\t\t\t\tif(!result.type) {\n\t\t\t\t\t\t\tres.type = result.type\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn res.sendFile(result.path, result.options)\n\t\t\t\t\t}\n\t\t\t\t\treturn res.status(result.status).send('error boy')\n\t\t\t\t}\n\t\t\t\treturn res.status(404).send('url not found')\n\t\t\t})\n\t\t\n\t\t\tapp.listen(OPTS.port, () => {\n\t\t\t\tconsole.log(log.bold(`Serph is up on ${log.url(`localhost:${OPTS.port}`)}`))\n\t\t\t})\n\t\t}\n\t\telse{\n\t\t\tconsole.error(log.error('file index.html not found'))\n\t\t}\n\t})\n\nprogram\n\t.command('deploy')\n\t.description('deploy your static site to serph.network')\n\t.action(function () {\n\t\tcmdValue = 'deploy'\n\n\t\tdeploy()\n\t})\n\nprogram\n\t.command('link')\n\t.description('create new link to your deployment')\n\t.arguments('<deployment> <new_link>')\n\t.action(async function (deployment, new_link) {\n\t\tcmdValue = 'link'\n\n\t\tlink(deployment, new_link)\n\t})\n\nprogram\n\t.command('register')\n\t.description('register to serph.network')\n\t.action(function () {\n\t\tcmdValue = 'register'\n\t\t\n\t\tregister()\n\t})\t\n\nprogram\n\t.command('login')\n\t.description('login with serph account')\n\t.action(function () {\n\t\tcmdValue = 'login'\n\t\t\n\t\tlogin()\n\t})\n\nprogram\n\t.command('logout')\n\t.description('logout evius account in this system')\n\t.action(function () {\n\t\tcmdValue = 'login'\n\t\tconst authFile = path.join(homedir, '.serph', 'auth.json')\n\t\tif(existsSync(authFile)) {\n\t\t\tconst auth = JSON.parse(readFileSync(authFile))\n\t\t\tatma.logout(auth.token)\n\t\t\tunlinkSync(authFile)\n\t\t\tconsole.log('Successfully logged out')\n\t\t\tprocess.exit(0)\n\t\t}\n\t\telse{\n\t\t\tconsole.log('Not logged in')\n\t\t\tprocess.exit(0)\n\t\t}\n\t})\n\nprogram.parse(process.argv)\n\nif (typeof cmdValue === 'undefined') {\n\tprogram.help()\n\tprocess.exit(1)\n}"]}