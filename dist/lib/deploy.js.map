{"version":3,"sources":["../../src/lib/deploy.js"],"names":["BASE_URL","stripPath","index","targetPath","PATH_SPLIT","split","path","sep","slice","join","fullPath","APP_DIR","baseSplit","baseFinal","length","hashGeneration","files","process","cwd","APP_DIR_SPLIT","APP_INDEX","OWNER_PATH","inputFiles","map","file","content","toPull","source","Promise","resolve","reject","IPLD","inMemory","err","ipld","pull","values","onlyHash","node","hash","CID","multihash","toBaseEncodedString","isDir","isDirectory","address","collect","pop","pre","user","config","accessToken","_err","utils","auth","requestAccessToken","token","logger","error","console","log","ignores","bold","final","request","post","url","form","filesAddress","JSON","stringify","headers","authorization","httpResponse","body","exit","parseBody","parse","data","filesToUpload","deploymentPath","similarName","similarHash","prompt","question","answer","toLowerCase","main","filesToPack","filter","f","buff","tarStream","tar","pack","entries","pipe","zlib","Gzip","totalData","on","push","formatBytes","progressBar","_cliProgress","Bar","format","start","progress","readable","Buffer","concat","update","stop","r","timeout","status","link","target","core","preResult","deploy","isLoggedIn","parseConfig"],"mappings":"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","file":"deploy.js","sourcesContent":["import path from 'path'\nimport { existsSync, readFileSync, statSync, createReadStream } from 'fs'\n\nimport tar from 'tar-fs'\nimport zlib from 'zlib'\nimport _cliProgress from 'cli-progress'\nimport toStream from 'buffer-to-stream'\nimport request from 'request'\nimport recursive from 'recursive-readdir'\n\nimport utils from './utils'\nimport log from './log'\n\nimport {importer} from 'ipfs-unixfs-engine'\nimport IPLD from 'ipld'\nimport pull from 'pull-stream'\nimport CID from 'cids'\nimport toPull from 'stream-to-pull-stream'\n\n// const BASE_URL = 'http://localhost:7000'\nconst BASE_URL = 'http://serph.network'\n\nconst stripPath = (index, targetPath) => {\n\tconst PATH_SPLIT = targetPath.split(path.sep)\n\treturn `${PATH_SPLIT.slice(index - 1).join(path.sep)}`\n}\n\nconst fullPath = (APP_DIR, targetPath) => {\n\tconst baseSplit = APP_DIR.split('/')\n\tconst baseFinal = baseSplit.slice(0, baseSplit.length - 1).join('/')\n\treturn path.join(baseFinal, targetPath)\n}\n\nconst hashGeneration = (files) => {\n\tconst APP_DIR = process.cwd()\n\tconst APP_DIR_SPLIT = APP_DIR.split(path.sep)\n\tconst APP_INDEX = APP_DIR_SPLIT.length\n\tconst OWNER_PATH = stripPath(APP_INDEX, `${APP_DIR}/owner`)\n\n\tconst inputFiles = files.map((file) => ({\n\t\tpath: stripPath(APP_INDEX, file),\n\t\tcontent: toPull.source(createReadStream(file))\n\t}))\n\n\treturn new Promise((resolve, reject) => {\n\t\tIPLD.inMemory((err, ipld) => {\n\t\t\tpull(\n\t\t\t\tpull.values(inputFiles),\n\t\t\t\timporter(ipld, {\n\t\t\t\t\tonlyHash: true\n\t\t\t\t}),\n\t\t\t\tpull.map((node) => ({\n\t\t\t\t\tpath: stripPath(2, node.path),\n\t\t\t\t\thash: new CID(0, 'dag-pb', node.multihash).toBaseEncodedString(),\n\t\t\t\t\tisDir: node.path === OWNER_PATH ? false : statSync(fullPath(APP_DIR, node.path)).isDirectory()\n\t\t\t\t})),\n\t\t\t\t// pull.filter((node) => ( !node.isDir )),\n\t\t\t\tpull.map((node) => ({\n\t\t\t\t\tpath: node.path,\n\t\t\t\t\thash: node.hash,\n\t\t\t\t\tisDir: node.isDir,\n\t\t\t\t\taddress: {\n\t\t\t\t\t\t[`/${node.path}`]: node.hash\n\t\t\t\t\t}\n\t\t\t\t})),\n\t\t\t\tpull.collect((err, files) => {\n\t\t\t\t\tif(err) return reject(err)\n\t\t\t\t\t// console.log(files)\n\t\t\t\t\tfiles.pop()\n\t\t\t\t\tresolve(files)\n\t\t\t\t})\n\t\t\t)\n\t\t})\n\t})\n}\n\nconst pre = async (user, config) => {\n\treturn new Promise(async (resolve) => {\n\t\tlet [accessToken, _err] = await utils.auth.requestAccessToken(user.token)\n\n\t\tif(_err) return utils.logger.error(_err)\n\n\t\tconst APP_DIR = process.cwd()\n\n\t\tconsole.log('> preparing your files...')\n\n\t\tconst ignores = (config && config.ignores) ? config.ignores : ['']\n\t\n\t\trecursive(APP_DIR, ignores, async (err, files) => {\n\t\t\tconsole.log(`> generating hash address for ${log.bold(files.length)} files...`)\n\t\t\tconst final = await hashGeneration(files)\n\n\t\t\trequest.post({\n\t\t\t\turl: `${BASE_URL}/api/deployments/prepare`,\n\t\t\t\tform: {\n\t\t\t\t\tfilesAddress: JSON.stringify(final)\n\t\t\t\t},\n\t\t\t\theaders: {\n\t\t\t\t\tauthorization: `bearer ${accessToken}`\n\t\t\t\t}\n\t\t\t}, (err, httpResponse, body) => {\n\t\t\t\tif(err) {\n\t\t\t\t\tconsole.log(err)\n\t\t\t\t\treturn process.exit(1)\n\t\t\t\t}\n\t\t\t\ttry {\n\t\t\t\t\tconst parseBody = JSON.parse(body)\n\n\t\t\t\t\tif(parseBody.data.filesToUpload.length > 0) {\n\t\t\t\t\t\tresolve({\n\t\t\t\t\t\t\tdeploymentPath: parseBody.data.deploymentPath,\n\t\t\t\t\t\t\tfilesToUpload: parseBody.data.filesToUpload\n\t\t\t\t\t\t})\n\t\t\t\t\t}\n\t\t\t\t\telse{\n\t\t\t\t\t\tconsole.log(`> no new files to be deployed`)\n\t\t\t\t\t\tif(parseBody.data.similarName) {\n\t\t\t\t\t\t\tconsole.log(`> similar deployment found at ${log.url(`https://${parseBody.data.similarName}.serph.network`)}`)\n\t\t\t\t\t\t\tconsole.log(`  > Hash: ${log.bold(parseBody.data.similarHash)}`)\n\t\t\t\t\t\t}\n\t\t\t\t\t\tutils.prompt.question('> continue deployment? [yes/no] ', async (answer) => {\n\t\t\t\t\t\t\tanswer = answer.toLowerCase()\n\t\t\t\t\t\t\tif(answer === 'y' || answer === 'yes') {\n\t\t\t\t\t\t\t\tresolve({\n\t\t\t\t\t\t\t\t\tdeploymentPath: parseBody.data.deploymentPath,\n\t\t\t\t\t\t\t\t\tfilesToUpload: parseBody.data.filesToUpload\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse{\n\t\t\t\t\t\t\t\tprocess.exit(0)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\n\t\t\t\t\t}\n\t\t\t\t} catch (err) {\n\t\t\t\t\tconsole.log(err)\n\t\t\t\t\tprocess.exit(1)\n\t\t\t\t}\n\t\t\t})\n\t\t})\n\t})\n}\n\nconst main = async (user, config, deploymentPath, filesToUpload) => {\n\treturn new Promise(async (resolve) => {\n\t\tconst APP_DIR = process.cwd()\n\n\t\tif(existsSync(path.join(APP_DIR, 'index.html'))) {\n\t\t\tconsole.log(`> packing ${log.bold(filesToUpload.length)} files...`)\n\t\t\tconst filesToPack = filesToUpload.filter((f) => ( f !== 'owner' ))\n\n\t\t\tlet [accessToken, _err] = await utils.auth.requestAccessToken(user.token)\n\t\t\tif(_err) return console.error(_err)\n\n\t\t\tlet buff = []\n\n\t\t\tconst tarStream = tar.pack(APP_DIR, {\n\t\t\t\tentries: filesToPack\n\t\t\t}).pipe(zlib.Gzip())\n\n\t\t\tlet totalData = 0\n\t\t\ttarStream.on('data', (data) => {\n\t\t\t\ttotalData += data.length\n\t\t\t\tbuff.push(data)\n\t\t\t})\n\t\t\ttarStream.on('end', () => {\n\t\t\t\tconsole.log(`> deploying to ${log.bold('serph.network')} [${utils.formatBytes(totalData)}]`)\n\t\t\t\tconst progressBar = new _cliProgress.Bar({\n\t\t\t\t\tformat: '  > upload [{bar}] {percentage}% | ETA: {eta}s'\n\t\t\t\t})\n\t\t\t\tprogressBar.start(100, 0)\n\t\t\t\tlet progress = 0\n\t\t\t\tconst readable = toStream(Buffer.concat(buff))\n\t\t\t\t\n\t\t\t\treadable.on('error', (err) => {\n\t\t\t\t\tthrow err\n\t\t\t\t})\n\t\t\t\treadable.on('data', (data) => {\n\t\t\t\t\tprogress += data.length\n\t\t\t\t\tprogressBar.update(progress*100/totalData)\n\t\t\t\t})\n\t\t\t\treadable.on('end', () => {\n\t\t\t\t\tprogressBar.stop()\n\t\t\t\t\tconsole.log(`> building your deployment...`)\n\t\t\t\t\t// if(filesToPack.length > 1000) {\n\t\t\t\t\t// \tconsole.log(`> processing huge amount of files [${filesToPack.length}]. probably `)\n\t\t\t\t\t// }\n\t\t\t\t})\n\n\t\t\t\tconst r = request.post({\n\t\t\t\t\turl: `${BASE_URL}/api/deployments/upload-cli`,\n\t\t\t\t\theaders: {\n\t\t\t\t\t\t'authorization': `bearer ${accessToken}`,\n\t\t\t\t\t\t'x-serph-deployment': deploymentPath\n\t\t\t\t\t},\n\t\t\t\t\ttimeout: 1000 * 60 * 10\n\t\t\t\t}, async (err, httpResponse, body) => {\n\t\t\t\t\tif(err) {\n\t\t\t\t\t\tconsole.log(err)\n\t\t\t\t\t\treturn process.exit(1)\n\t\t\t\t\t}\n\t\t\t\t\tconst parseBody = JSON.parse(body)\n\n\t\t\t\t\tif(parseBody.status === 'error') {\n\t\t\t\t\t\tconsole.log(log.error('> Something went wrong. Please come back later.'))\n\t\t\t\t\t\tconsole.log(parseBody)\n\t\t\t\t\t\treturn process.exit(1)\n\t\t\t\t\t}\n\t\t\t\t\tresolve()\n\t\t\t\t})\n\n\t\t\t\treadable.pipe(r)\n\t\t\t})\n\t\t}\n\t\telse{\n\t\t\tconsole.error(`${log.error('index.html')} not found`)\n\t\t\tprocess.exit(1)\n\t\t}\n\t})\t\n}\n\nconst post = async (user, config, deploymentPath) => {\n\tif(config && config.link) {\n\t\tconsole.log(`> link was found on ${log.bold(`serph.json`)}`)\n\t\tconsole.log(`> linking ${log.bold(config.link)} to new deployment (${log.bold(deploymentPath)})`)\n\t\t\n\t\tlet [accessToken, _err] = await utils.auth.requestAccessToken(user.token)\n\t\tif(_err) return console.error(_err)\n\n\t\trequest.post({\n\t\t\turl: `${BASE_URL}/api/links`,\n\t\t\tform: {\n\t\t\t\tlink: config.link,\n\t\t\t\ttarget: deploymentPath\n\t\t\t},\n\t\t\theaders: {\n\t\t\t\tauthorization: `bearer ${accessToken}`\n\t\t\t}\n\t\t}, (err, httpResponse, body) => {\n\t\t\tif(err) {\n\t\t\t\tconsole.log(err)\n\t\t\t\treturn process.exit(1)\n\t\t\t}\n\n\t\t\tconst data = JSON.parse(body).data\n\n\t\t\tconsole.log(`> online at ${log.url(`https://${data.link}.serph.network`)}`)\n\t\t\treturn process.exit(0)\n\n\t\t})\n\t}\n\telse{\n\t\tconsole.log(`> online at ${log.url(`https://${deploymentPath}.serph.network`)}`)\n\t\treturn process.exit(0)\t\t\n\t}\n}\n\nconst core = async (user, config) => {\n\tconst preResult = await pre(user, config)\n\tif(preResult) {\n\t\tawait main(user, config, preResult.deploymentPath, preResult.filesToUpload)\t\n\t\tawait post(user, config, preResult.deploymentPath)\n\t}\n}\n\nconst deploy = async () => {\n\tconst APP_DIR = process.cwd()\n\n\tif(!existsSync(path.join(APP_DIR, 'index.html'))) {\n\t\tconsole.error(`> ${log.error('index.html not found')}`)\n\t\tprocess.exit(1)\n\t}\n\n\tconsole.log('> authenticating...')\n\n\tconst user = utils.auth.isLoggedIn()\n\tif(user) {\n\t\tif(existsSync(path.join(APP_DIR, 'serph.json'))) {\n\t\t\tconst config = readFileSync(path.join(APP_DIR, 'serph.json'))\n\t\t\ttry {\n\t\t\t\tconst parseConfig = JSON.parse(config)\n\t\t\t\tcore(user, parseConfig)\n\t\t\t}\n\t\t\tcatch(err) {\n\t\t\t\tconsole.log(err)\n\t\t\t\tprocess.exit(1)\n\t\t\t}\n\t\t}\n\t\telse{\n\t\t\tcore(user)\n\t\t}\n\t}\n\telse{\n\t\tconsole.log(`> please login using ${log.bold(`serph login`)}`)\n\t\tprocess.exit(0)\n\t}\n}\n\nexport default deploy"]}