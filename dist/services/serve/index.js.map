{"version":3,"sources":["../../../src/services/serve/index.js"],"names":["router","express","Router","sitePath","opts","options","dotfiles","showHidden","get","req","res","targetPath","originalUrl","split","target","path","join","stat","fs","statSync","isFile","mime","lookup","type","sendFile","err","send","views","page404","toString","spa","errno"],"mappings":";;;;;;AAAA;;;;AACA;;;;AACA;;;;AAEA;;;;AAEA;;;;;;AAEA,MAAMA,SAASC,kBAAQC,MAAR,EAAf;;kBAEe,CAACC,QAAD,EAAWC,IAAX,KAAoB;;AAElC,OAAMC,UAAU;AACfC,YAAUF,KAAKG,UAAL,GAAkB,OAAlB,GAA2B;AADtB,EAAhB;;AAIAP,QAAOQ,GAAP,CAAW,GAAX,EAAgB,OAAOC,GAAP,EAAYC,GAAZ,KAAoB;AACnC,QAAMC,aAAaF,IAAIG,WAAJ,CAAgBC,KAAhB,CAAsB,GAAtB,EAA2B,CAA3B,CAAnB;AACA,MAAI;AACH,SAAMC,SAASC,eAAKC,IAAL,CAAUb,QAAV,EAAoBQ,UAApB,CAAf;AACA,SAAMM,OAAO,MAAMC,aAAGC,QAAH,CAAYL,MAAZ,CAAnB;AACA,OAAGG,KAAKG,MAAL,EAAH,EAAkB;AACjB,QAAG,CAACC,oBAAKC,MAAL,CAAYR,MAAZ,CAAJ,EAAwB;AACvBJ,SAAIa,IAAJ,CAAS,YAAT;AACA;AACD,WAAOb,IAAIc,QAAJ,CAAaV,MAAb,EAAqBT,OAArB,CAAP;AACA,IALD,MAMI;AACH,QAAGM,eAAe,GAAlB,EAAuB;AACtB,YAAOD,IAAIc,QAAJ,CAAaT,eAAKC,IAAL,CAAUb,QAAV,EAAqB,YAArB,CAAb,CAAP;AACA;AACD,WAAOO,IAAIc,QAAJ,CAAaT,eAAKC,IAAL,CAAUb,QAAV,EAAqB,GAAEQ,UAAW,OAAlC,CAAb,EAAyDc,GAAD,IAAS;AACvE,SAAGA,GAAH,EAAQ;AACP,aAAOf,IAAIgB,IAAJ,CAASC,gBAAMC,OAAN,GAAgBC,QAAhB,EAAT,CAAP;AACA;AACD,KAJM,CAAP;AAKA;AACD,GAnBD,CAmBE,OAAMJ,GAAN,EAAW;AACZ,OAAGrB,KAAK0B,GAAL,IAAY,IAAf,EAAqB;AACpB,WAAOpB,IAAIc,QAAJ,CAAaT,eAAKC,IAAL,CAAUb,QAAV,EAAqB,YAArB,CAAb,CAAP;AACA;AACD,OAAGsB,IAAIM,KAAJ,IAAa,CAAC,CAAjB,EAAoB;AACnB,WAAOrB,IAAIgB,IAAJ,CAASC,gBAAMC,OAAN,GAAgBC,QAAhB,EAAT,CAAP;AACA;AACD,UAAOnB,IAAIgB,IAAJ,CAASD,GAAT,CAAP;AACA;AACD,EA9BD;;AAgCA,QAAOzB,MAAP;AACA,C","file":"index.js","sourcesContent":["import express from 'express'\nimport path from 'path'\nimport fs from 'fs'\n\nimport mime from 'mime-types'\n\nimport views from '../../views'\n\nconst router = express.Router()\n\nexport default (sitePath, opts) => {\n\n\tconst options = {\n\t\tdotfiles: opts.showHidden ? 'allow': 'deny'\n\t}\n\n\trouter.get('*', async (req, res) => {\n\t\tconst targetPath = req.originalUrl.split('?')[0]\n\t\ttry {\n\t\t\tconst target = path.join(sitePath, targetPath)\n\t\t\tconst stat = await fs.statSync(target)\n\t\t\tif(stat.isFile()) {\n\t\t\t\tif(!mime.lookup(target)){\n\t\t\t\t\tres.type('text/plain')\n\t\t\t\t}\n\t\t\t\treturn res.sendFile(target, options)\n\t\t\t}\n\t\t\telse{\n\t\t\t\tif(targetPath === '/') {\n\t\t\t\t\treturn res.sendFile(path.join(sitePath, `index.html`))\n\t\t\t\t}\n\t\t\t\treturn res.sendFile(path.join(sitePath, `${targetPath}.html`), (err) => {\n\t\t\t\t\tif(err) {\n\t\t\t\t\t\treturn res.send(views.page404().toString())\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t}\n\t\t} catch(err) {\n\t\t\tif(opts.spa == true) {\n\t\t\t\treturn res.sendFile(path.join(sitePath, `index.html`))\n\t\t\t}\n\t\t\tif(err.errno == -2) {\n\t\t\t\treturn res.send(views.page404().toString())\n\t\t\t}\n\t\t\treturn res.send(err)\n\t\t}\n\t})\n\n\treturn router\n}"]}